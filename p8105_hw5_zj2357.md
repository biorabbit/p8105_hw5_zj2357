p8105_hw5_zj2357
================
Zekai Jin
2022-11-14

First of all, we should include the libraries we are using and prepare
the dataset.

``` r
library(tidyverse)
knitr::opts_chunk$set(
  message  = FALSE,
  warning = FALSE,
  fig.width = 8, 
  fig.height = 6,
  out.width = "90%"
)
```

# Problem 1

read and tidy the data

``` r
f_names = list.files("data", pattern = "(exp|con)_\\d\\d.csv")

joined_df = 
  map_dfr(str_c("data/",f_names),read_csv) %>%
  mutate(
    id = str_replace(f_names, ".csv", ""),
    group = as.factor(str_replace(f_names, "_\\d\\d.csv", ""))
  ) %>%
  select(id, group, everything()) 

write_csv(joined_df, "data/tidy/result.csv")
```

making a plot

``` r
joined_df %>%
  pivot_longer(
    week_1:week_8,
    names_to = "week",
    names_prefix = "week_",
    values_to = "value"
  ) %>%
  mutate(week = as.numeric(week)) %>%
  ggplot(aes(x = week,y = value, color = group, group = id)) +
  geom_line()
```

<img src="p8105_hw5_zj2357_files/figure-gfm/unnamed-chunk-2-1.png" width="90%" />

# Problem 2

``` r
rm(list = ls())

homi_df = read_csv("data/homicide-data.csv")
```

``` r
homi_df = 
  homi_df %>%
  mutate(
    city_state = str_c(city, ",", state) 
  ) %>%
  group_by(city_state) %>%
  summarise(
    n_obs = n(),
    unsolved = sum(disposition %in% c("Closed without arrest","Open/No arrest"))
  )
  
homi_filt = filter(homi_df,city_state == "Baltimore,MD")
test_res =  prop.test(x = homi_filt$unsolved, n = homi_filt$n_obs)
save(test_res, file = "results/prop_test_BMD.RData")
broom::tidy(test_res) %>%
  select(estimate, conf.low,conf.high)
```

    ## # A tibble: 1 × 3
    ##   estimate conf.low conf.high
    ##      <dbl>    <dbl>     <dbl>
    ## 1    0.646    0.628     0.663

``` r
conf_int =
  map2_df(.x = homi_df$unsolved, .y = homi_df$n_obs, .f =  ~broom::tidy(prop.test(.x,.y))) %>%
  mutate(city_state = homi_df$city_state) %>%
  select(city_state, estimate, conf.low,conf.high)

conf_int
```

    ## # A tibble: 51 × 4
    ##    city_state     estimate conf.low conf.high
    ##    <chr>             <dbl>    <dbl>     <dbl>
    ##  1 Albuquerque,NM    0.386    0.337     0.438
    ##  2 Atlanta,GA        0.383    0.353     0.415
    ##  3 Baltimore,MD      0.646    0.628     0.663
    ##  4 Baton Rouge,LA    0.462    0.414     0.511
    ##  5 Birmingham,AL     0.434    0.399     0.469
    ##  6 Boston,MA         0.505    0.465     0.545
    ##  7 Buffalo,NY        0.612    0.569     0.654
    ##  8 Charlotte,NC      0.300    0.266     0.336
    ##  9 Chicago,IL        0.736    0.724     0.747
    ## 10 Cincinnati,OH     0.445    0.408     0.483
    ## # … with 41 more rows

``` r
conf_int %>%
  mutate(
    city_state = fct_reorder(city_state, -estimate)
  ) %>%
  ggplot(aes(x = estimate, y = city_state)) +
  geom_point()+
  geom_errorbar(aes(xmin = conf.low, xmax = conf.high))
```

<img src="p8105_hw5_zj2357_files/figure-gfm/unnamed-chunk-6-1.png" width="90%" />

# Problem 3

``` r
rm(list=ls())

prop_rej <- function(u = 0, sigma = 5, n = 30, n_dataset = 5000){
  dataset = map(.x = rep(u, n_dataset), .f = ~tibble(data=rnorm(n,.x,sigma))) %>%
    map(t.test) %>%
    map_df(broom::tidy)

  p_rej = dataset %>%
    filter(p.value < 0.05)%>%
    nrow() %>%
    `/`(n_dataset)

  u_est = dataset %>%
    pull(estimate) %>%
    mean()
  
  u_rej = dataset %>%
    filter(p.value < 0.05) %>%
    pull(estimate) %>%
    mean()
  
  tibble(u=u, p_rej = p_rej, u_est = u_est, u_rej = u_rej)
}


# iterating over u = 0:6
exp_res = 
  0:6 %>%
  map_df(prop_rej)
```

``` r
exp_res %>%
  ggplot(aes(x=u,y=p_rej)) +
  geom_line() +
  scale_y_continuous(labels = scales::percent_format(scale = 100)) +
  scale_x_continuous(breaks = 0:6)+
  ylab("percentage of rejection")+
  labs(title = "Percentage of Rejection over Different u")
```

<img src="p8105_hw5_zj2357_files/figure-gfm/unnamed-chunk-8-1.png" width="90%" />

``` r
exp_res %>%
  pivot_longer(
    u_est:u_rej,
    names_to = "u_type",
    values_to = "u_est"
  ) %>%
  ggplot(aes(x=u,y=u_est, color = u_type)) +
  geom_line() +
  scale_color_discrete(labels = c("all", "rejected"))+
  scale_x_continuous(breaks = 0:6)+
  ylab("estimated u")+
  labs(title = "Comparasion of estimated between all and rejected samples")
```

<img src="p8105_hw5_zj2357_files/figure-gfm/unnamed-chunk-9-1.png" width="90%" />
